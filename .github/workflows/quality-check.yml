name: Code Quality Agent Validation

on:
  pull_request:
    branches: [ main, develop, master ]
  push:
    branches: [ main, develop, master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  validate-agent:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate script syntax
        run: |
          node --check scripts/quality-check.js
          echo "✅ Script syntax is valid"
      
      - name: Validate required files exist
        run: |
          test -f .cursorrules && echo "✅ .cursorrules exists" || (echo "❌ .cursorrules missing" && exit 1)
          test -f scripts/quality-check.js && echo "✅ quality-check.js exists" || (echo "❌ quality-check.js missing" && exit 1)
          test -f README.md && echo "✅ README.md exists" || (echo "❌ README.md missing" && exit 1)
          test -f package.json && echo "✅ package.json exists" || (echo "❌ package.json missing" && exit 1)
          echo "✅ All required files present"
      
      - name: Test script execution (dry run)
        run: |
          # Test that the script can at least start without errors
          node scripts/quality-check.js --project-root . 2>&1 | head -20 || echo "Script executed (may have found issues, which is expected)"
      
      - name: Validate package.json
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" && echo "✅ package.json is valid JSON"
      
      - name: Check file permissions
        run: |
          test -x scripts/quality-check.js && echo "✅ Script is executable" || echo "⚠️ Script is not executable (may need chmod +x)"
